# 软渲染

----------
之前看过DX的龙书，对软渲染的流程有一定程度的了解，但是光栅化的细节讲得很简略，大多数问题出在这里，主要时间花在性能优化、边界处理、以及修复BUG上。代码部分采用了DX教程的框架，一开始并没有预料到数学库对应的性能不尽人意。

----------

##主要实现
- 立方体绕世界坐标X/Y轴旋转、设置相机以及移动
- Z-buffer,虽然一开始就实现了，但是后期测试发现很耗性能，所以最后测试的时候舍去了
- back-culling，虽然说是可选的，但是不加，性能会很差
- BlinPhong光照模型
- 双线性插值
- 远近平面裁剪(验收的时候还没加，后续加了) 
- 近距离全屏目三面显示不旋转可稳定到70+FPS
- 近距离全屏三面显示旋转偶尔会降到65FPS左右，平均在70FPS左右
- 以上性能前提是CPU不被其他程序占用
- 上述性能机子配置：CPU i5 6500 3.3GHz 四核四线程

----------

##光栅化优化考虑
- 包围盒算法（便于openMP并行计算，用schedule(dynamic)尽可能刷利用CPU）
- 计算重心坐标，只需计算一个点的重心，以及重心坐标对应在二维平面的梯度，即可快速算出包围盒中任意一点的重心坐标
- 判断二维平面点是否在三角形里，只需要重心坐标都大于等于0.0f即可，不需要多计算小于等于1
- 扫描包围盒的一行时，记录前一个点是否在三角形内，如果下一个点在三角形外，意味后续都在三角形外，可以不做计算

----------

##光照优化考虑
- 计算高光时，pow函数的指数是整数，可以用O(logN)算法优化，不考虑gamma校正就不需要浮点数指数的pow

----------

##遇到问题
- 透视校正的时候，没有仔细考虑，用了投影坐标归一化后的z，应该用视角坐标对应的z
- 投影矩阵会对称地将视角前后两个投影视锥内的三角形转化到投影坐标内，主要解决方式是在视角坐标内判断三角形的三个点的坐标的z是否都小于0
- 三角形之间重复边漏点问题，一开始考虑花了一个三角形全部部分后，如果别的三角形有重复像素就不再画了（类似zBuffer），后来建议使用left-top规则严格处理边界以及对应顶点，明确顶点的法线只能由特定一个三角形决定（非曲面）
- 读纹理的时候，对纹理格式不了解等等。
- 画图主要用了Win32窗口用一个Buffer直接填充，然后发现在我的电脑配置的时候只调用一次画图函数BitBlt会出现移动视角或旋转失真问题，但是在倪骏扬的电脑那边没有任何问题，连续用了两次画图函数才在自己电脑上解决，所以上述性能低了大概2~3FPS左右

##更多优化考虑
- 做转化到世界坐标和视角坐标的矩阵计算的时候，多余一列的(0,0,0,1)是没有必要加入计算，可以减少空间与时间，因为在DX里面就是转置以后舍去最后一行再传矩阵的。
